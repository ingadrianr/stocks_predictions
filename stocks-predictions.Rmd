---
title: "Pronóstico De Índices Financieros"
author: "Adrián Rodríguez Amaya & Katherin Juliana Quiñones Losada"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
output: bookdown::gitbook
---
---
title: "Pronóstico De Índices Financieros"
author: "Adrián Rodríguez Amaya & Katherin Juliana Quiñones Losada"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
output: bookdown::gitbook
---

# Descargo De Responsabilidad {-}

La información consignada dentro de este libro se presenta solo para fines educativos. No constituye ninguna oferta, recomendación o solicitud para que ninguna persona realice una transacción, negociación o inversión, ni constituye una predicción de probable movimiento futuro en los índices financieros que sean presentados en cualquier ilustración o mencionados textualmente dentro del libro.

Las personas con acceso al presente libro deben buscar asesoramiento profesional sobre la idoneidad de invertir en valores, instrumentos financieros o estrategias de inversión. Las opiniones, proyecciones y estimaciones consignadas en este libro están sujetas a cambios sin previo aviso.

ADRIAN MAURICIO RODRIGUEZ AMAYA y KATHERIN JULIANA QUIÑONES LOSADA no son asesores de inversiones y no pretende brindarle asesoramiento sobre inversiones, legal o fiscal y no es responsable de ninguna pérdida que surja de cualquier inversión basada en una recomendación percibida.


<!--chapter:end:index.Rmd-->

# Introducción

El presente libro pretende realizar un ejercicio académico relacionado con el pronóstico de los precios de índices financieros. La información será obtenida a través de la API de Yahoo Finance .

Para ser más exactos nos interesa analizar y trabajar en los retornos a partir de precios de cierre de diferentes acciones en la etapa pre y post pandemia (Ene 2019- Dic 2021). En Yahoo Finance podemos encontrar diferentes acciones asociados a diferentes índices. Para poder acotar el ejercicio nos centraremos en trabajar sobre uno de los índices mas populares a nivel mundial como es el S&P 500 (Standard and Poor’s 500).

El S&P 500, aunque incluye 500 compañías de gran tamaño en Estados Unidos, no se puede asegurar con completa certeza que son las 500 mas grandes. Estas 500 empresas deben cumplir diferentes normas regulatorias, que van desde cotizar inicialmente en índices como NASDAQ, como la capitalización bursátil debe superar los 6.100 millones de dólares (este valor se suele ajustar cada año). S&P trabaja en función de la representación de la industria, el tamaño de la empresa, el número de accionistas, el volumen de negociación y la solidez financiera.

Standard and Poor’s afirma que utiliza el requisito de solidez financiera para garantizar la estabilidad del Índice y que este requisito se basa únicamente en información disponible públicamente.[2]

La composición por sector dentro de este índice, se distribuye en un 26% del sector de tecnología; el 14% corresponde al sector financiero, el sector salud 13,9% consumo discrecional 12,9%, industria 9,9%, consumo masivo 6,7%, energía 6,3%, materiales, 2,8%, servicios públicos 2,8%, real estate 2,7%, y telecomunicaciones el restante 1,8%.

Entre algunas empresas que se destacan se encuentran APPLE, AMAZON, FACEBOOK, entre otras. Este indicador es popular por proveer al inversionista, una cartera diversificada y de bajo riesgo, lo cual suena bastante positivo para un inversor con perfil de riesgo bajo.[3]

Ahora bien, el interés en este tipo de datos, nace de identificar el reto que representa trabajar con datos tan volátiles como puede llegar a representar los precios de cierre de las acciones. Estos datos requerirán un fuerte análisis exploratorio para identificar patrones, tendencias y diferentes conceptos asociados a series de tiempo que deben evaluarse de manera previa y a profundidad, para lograr un proceso de modelado ideal. Posteriormente, nos enfocaremos en hacer uso de pronósticos con el fin de establecer futuros comportamientos del retorno de las acciones correspondientes al índice S&P 500. Dentro del desarrollo del ejercicio académico se harán definiciones que permitan acotar el entregable como por el ejemplo, el número de empresas a trabajar, el número de días a predecir, las variables explicativas a trabajar (univariado o multivariado, como uso del PIB de USA, precio del dólar, entre otros).

Además, quisiéramos evaluar como las técnicas tradicionales (métodos estadísticos) se comportan versus técnicas mas recientes como las de Machine Learning (ML). Nuestro objetivo no es descartar una herramienta o la otra, nuestro objetivo es poder identificar las bondades de cada una en la aplicación de series de tiempo en nuestra vida profesional y/o académica.

El pronóstico calculado nos permitirá descubrir el valor futuro de del valor de las acciones de una empresa en particular; esto permitirá tanto a los inversores como a las empresas tomar decisiones oportunas frente a las dinámicas del negocio.

![J. Smialek, « Fastest Inflation in 31 Years Puts More Heat on Washington» 2021. [En línea]. Disponible en: https://www.nytimes.com/2021/11/10/business/economy/consumer-price-inflation-october.html. [Consultado: Jun. 17, 2022].](./inflation-600.png)




<!--chapter:end:01-Intro.Rmd-->

# Definiciones

A partir del listado de compañías que sean seleccionadas se definirán algunas condiciones previas para desarrollar el ejercicio propuesto. Primeramente, se define que el porcentaje de datos que se utilizarán para el entrenamiento será de 80% y el porcentaje de datos utilizados para validación y pruebas será del 20%.
El periodo que se desea pronosticar será de siete (7) días, con un rezago estimado dentro del rango de cinco (5) a diez (10) días. 

Por otra parte, el rango de fechas que se utilizarán para los datos de entrenamiento será de doce (12) meses, comprendidos entre 01-Ene-2022 a 30-Dic-2022 y el rango de fechas para tomar los datos de validación y pruebas será de cuatro (4) meses y definido entre 01-Ene-2023 a 30-Abr-2023.

## S&P 500 Top 10

El índice Standard & Poor’s 500 o mejor conocido como S&P 500 es un índice que rastrea los precios de las 500 empresas más grandes en Estados Unidos que representan en su mayoría algún mercado o industria en particular [4].
Para el presente ejercicio se tomarán las diez (10) empresas más representativas para este índice bursátil a partir de su peso, de acuerdo con [5] las primeras diez compañías de este índice son:

1.	APPL: Apple Inc.
2.	MSFT: Microsoft Corp
3.	AMZN: Amazon.com Inc
4.	NVDA: Nvidia Corp
5.	GOOGL: Alphabet Inc A
6.	BRK-B: Berkshire Hathaway B
7.	GOOG: Alphabet Inc C
8.	META: Meta Platforms, Inc. Class A
9.	XOM: Exxon Mobil Corp
10.	UNH: Unitedhealth Group Inc

## Cointegración 

De acuerdo con [6], el par de devisas EUR/USD representa el valor del dólar estadounidense por euro y representa más de la mitad de todo el volumen de negociación en el Mercado Forex.

A cada una de las series de tiempo de los índices definidos se les integrará el índice EURUSD=X de forma de todas ellas se encuentre cointegradas con este último. El objetivo es tratar de encontrar una posible correlación entre las series de tiempo a largo plazo entre el Top 10 de los índices del S&P 500 y el índice EURSD=X.

<!--chapter:end:02-Definiciones.Rmd-->


# Importación de los datos

Placeholder



<!--chapter:end:03-Importacion.Rmd-->


# Análisis Exploratorio de Datos

Placeholder


## Comportamiento Inicial Series
### Promedio Móvil y Rezagos
### Estacionalidad (Descomposicion Aditiva) 
## Estacionaridad
### Prueba Dickey- Fuller (ADF) Series naturales 
### ACF y PACF 
### Diferenciación 
### Prueba Dickey- Fuller (ADF) Series diferenciadas 

<!--chapter:end:04-EDA.Rmd-->


# Métodos de Suavizado 

Placeholder


## Método de Suavización Exponencial Simple
## Método de Holt-Winters

<!--chapter:end:05-Suavizaciones.Rmd-->


# Metodología Box-jenkins

Placeholder


## Identificacion del modelo
## Estimacion del modelo

<!--chapter:end:06-BoxJenkins.Rmd-->

```{r 07-00, include=FALSE}
library(tidyquant)
library(TTR)
library(ggplot2)
library(tidyquant)
library(tidyverse)
library(ggplot2)
library(scales)
library(tseries)
library(stats)
library(dplyr)
library(ggpubr)
library(forecast)
library(changepoint)
library(prophet)
library(tidyverse)
library(lubridate)
library(tsibble)
library(feasts)
library(fable)
library(fable.prophet)
library(plotly)

```

# Modelo Prophet


Prophet es un procedimiento para pronosticar datos de series temporales basado en un modelo aditivo en el que las tendencias no lineales  se ajustan a la estacionalidad anual, semanal y diaria, además  de los efectos de las vacaciones. Funciona mejor con series  temporales que tienen fuertes efectos estacionales y varias  temporadas de datos históricos. Prophet es resistente a los datos faltantes y los cambios en la tendencia, y por lo general maneja bien los valores atípicos.

Este modelo puede ser usado tanto para series univariadas o multivariadas.
Con los modelos de series temporales univariadas, la idea es hacer predicciones de valores futuros basadas únicamente en las tendencias y la estacionalidad de los  datos pasados de la variable objetivo (la que tratamos de pronosticar) y nada más.

Los modelos multivariantes son una extensión de eso, donde la entrada puede ser múltiples series de tiempo.

Acontinuación observaremos como es el comportamiento de 3 acciones puntuales, **"AAPL", "MSFT", "AMZN"** con el fin de poder tener una mejor visualización. En este caso la idea es probar ajustar un modelo prophet ajustado de forma manual, como por ejemplo escogiendo la tendencia, la temporalidad de la estacionalidad y si es aditiva o multiplicativa. Se comparara con un modelo prophet automatico, es decir ajustado por si mismo. En este momento el ejercicio esta ajustado de forma univariada.




```{r 07-1, warning=FALSE, message=FALSE, echo=FALSE}
empresas = c("AAPL", "MSFT",'GOOGL')
             #, "NVDA", "GOOGL","BRK-B","GOOG", "META","UNH","XOM")
precios <- tidyquant::tq_get(empresas, from = "2022-01-01", to = "2023-04-30", get = "stock.prices")
```

```{r 07-2, warning=FALSE, message=FALSE,echo=FALSE}

precios <- precios %>% 
  group_by(symbol) %>% 
  mutate(diferenciado1 = c(NA, diff(close, differences = 1)[-length(close)]))
```

```{r 07-3, warning=FALSE, message=FALSE}
'''

data <- data.frame(date = precios$date, close = precios$close, symbol=precios$symbol)

stock_i <- subset(data, symbol == 'AAPL')
stock_i <- subset(stock_i, select = -symbol)
colnames(stock_i) <- c("ds", "y")

model <- prophet(stock_i,  daily.seasonality = TRUE)


# Realizar pronósticos con prophet
future <- make_future_dataframe(model, periods = 10) 
forecast <- predict(model, future)

plot(model, forecast) +
   labs(title = paste("Modelo Prophet para",'AAPL'),
  x = "Fecha",
  y = "Precio Cierre")

'''
```


```{r 07-4, warning=FALSE, message=FALSE,echo=FALSE}
'''

data <- data.frame(date = precios$date, close = precios$close, symbol=precios$symbol)

stock_i <- subset(data, symbol == 'MSFT')
stock_i <- subset(stock_i, select = -symbol)
colnames(stock_i) <- c("ds", "y")

model <- prophet(stock_i,  daily.seasonality = TRUE)

# Realizar pronósticos con prophet
future <- make_future_dataframe(model, periods = 10) 
forecast <- predict(model, future)

plot(model, forecast) +
   labs(title = paste("Modelo Prophet para",'MSFT'),
  x = "Fecha",
  y = "Precio Cierre")

'''
```

```{r 07-5, warning=FALSE, message=FALSE,echo=FALSE}
'''

data <- data.frame(date = precios$date, close = precios$close, symbol=precios$symbol)

stock_i <- subset(data, symbol == 'GOOGL')
stock_i <- subset(stock_i, select = -symbol)
colnames(stock_i) <- c("ds", "y")

model <- prophet(stock_i,  daily.seasonality = TRUE)

# Realizar pronósticos con prophet
future <- make_future_dataframe(model, periods = 10) 
forecast <- predict(model, future)

plot(model, forecast) +
   labs(title = paste("Modelo Prophet para",'GOOGL'),
  x = "Fecha",
  y = "Precio Cierre")
'''

```


<h3> Exploración Inicial </h3>

En este caso convertimos el dataframe inicial es un tipo tsibble, con el fin de no utilizar un for para el desarrollo del modelo prophet si no asumir como un key la variable symbol, que nos sugiere la acción para la cual se esta realizando el ejercicio.

```{r 07-4, warning=FALSE, message=FALSE}

stock=subset(precios, select = c("close", "date",'symbol'))

stock <- stock %>% 
  as_tsibble(index = date,key = symbol)

stock %>% 
  autoplot(close)  +
  labs(title = "Exploracion Inicial del Precio Cierre",
       x = "Fecha",y = "Precio Cierre")
```


A continuación procederemos a construir los ajustes de los modelos propuestos inicialmente. Recordar las bondades que tiene el modelo prophet que entre ellas se encuentran el poder ajustar de forma sencilla los parametros asociados a tendencia, estacionalidad, vacaciones, entre otros.

```{r 07-5, warning=FALSE, message=FALSE}

library(tidyverse)
library(lubridate)
library(tsibble)
library(feasts)
library(fable)
library(fable.prophet)
library(plotly)

stock_apple=subset(precios, select = c("date","close" ,'symbol'))
stock_apple <- as_tsibble(stock_apple,index = date,key = symbol)

fit <- stock_apple %>% 
  model(
    Prophet        = prophet(close ~ growth("linear") + season("week", type = "additive")),
    Prophet_auto = prophet(close)
  )
fit
```
<h3> Prediccion </h3>

Acontinuación se relaciona el pronostico de los siguientes 7 dias.

```{r 07-6, warning=FALSE, message=FALSE}

fc <- fit %>% 
  forecast(h = 7)

fc %>% 
  autoplot(stock_apple)
```

<!--chapter:end:07-Prophet.Rmd-->

# Referencias

[1] https://finance.yahoo.com

[2] W. B. Elliot, B. F. Van Ness y M. Walker, «What drives the S&P 500 inclusion effect? An analytical survey,» Financial Managment, vol. 35, nº 4, pp. 31-48, 2006.

[3] Wilson y C. Jones, «An analysis of the S&P 500 index and Cowles’s extensions: Price indexes and stock returns,» The Journal of Business, vol. 75, nº 3, pp. 505-533, 2002.

[4] K. Tretania, B. Curry. “What Is The S&P 500? How Does It Work?” forbes.com. [En línea]. Disponible en: https://www.forbes.com/advisor/investing/what-is-sp-500/ (Consultado May. 7, 2023).

[5] S&P Dow Jones Indices. “Índices data” spglobal.com. [En línea]. Disponible en: https://www.spglobal.com/spdji/en/indices/equity/sp-500/#data (Consultado May. 7, 2023).

[6] FOREX. “EUR/USD” FOREX.com. [En línea]. Disponible en: https://www.forex.com/en/forex-trading/eur-usd/ (Consultado May. 7, 2023).

[7] F. Villareal. "Introducción a los Modelos de Pronósticos" uns.edu.ar. [En línea]. Disponible en: https://www.matematica.uns.edu.ar/uma2016/material/Introduccion_a_los_Modelos_de_Pronosticos.pdf (Consultado May. 10, 2023).

[8] DATA SCIENCE INSTITUTE TUTOR TEAM. "Time Series Decomposition in R" datascienceinstitute.net. [En línea]. Disponible en: https://www.datascienceinstitute.net/blog/time-series-decomposition-in-r (Consultado May. 10, 2023).

[9] Hanke, John E., and Dean W. “Wichern. Business forecasting”. Pearson Educación, 2005.

[10] J. Gonzalez. “Método Holt Winters” s3.amazonaws.com. [En línea]. Disponible en:
https://rstudio-pubs-static.s3.amazonaws.com/283115_72aea7c9fa224b89878c65ec53db3684.html  (Consultado May. 15, 2023).

[11] Minitab, LLC. “Métodos y fórmulas para la Método de Winters” minitab.com. [En línea]. Disponible en: https://support.minitab.com/es-mx/minitab/21/help-and-how-to/statistical-modeling/time-series/how-to/winters-method/methods-and-formulas/methods-and-formulas/ (Consultado May. 15, 2023).

<!--chapter:end:10-References.Rmd-->

